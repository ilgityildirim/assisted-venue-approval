<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="{{basePath}}">
    <title>Pending Manual Review - HappyCow Validation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: #2c3e50; color: white; padding: 20px 0; margin-bottom: 30px; }
        .header h1 { text-align: center; font-size: 2.0em; }
        .nav { display: flex; gap: 20px; margin-bottom: 30px; }
        .nav a { padding: 10px 20px; background: white; color: #2c3e50; text-decoration: none; border-radius: 5px; }
        .nav a.active, .nav a:hover { background: #3498db; color: white; }
        .filters { background: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .filters form { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .filters input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { display: inline-block; padding: 8px 16px; background: #3498db; color: white; text-decoration: none; border-radius: 4px; border: none; cursor: pointer; min-width: 80px; text-align: center; font-size: 14px; font-family: inherit; line-height: 1.5; box-sizing: border-box; }
        .btn:hover { background: #2980b9; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-pending { background: #fff3cd; color: #856404; }
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .pagination a { padding: 8px 12px; background: white; border: 1px solid #ddd; color: #333; text-decoration: none; }
        .pagination a.active { background: #3498db; color: white; }
        .batch-controls { margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 5px; }
        .selected-count { font-weight: bold; color: #856404; }
        .score-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .score-high { background: #d4edda; color: #155724; }
        .score-medium { background: #fff3cd; color: #856404; }
        .score-low { background: #f8d7da; color: #721c24; }
        .actions-column { white-space: nowrap; }
        .batch-results-list { list-style: none; padding: 0; }
        .batch-results-list li { padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #ddd; }
        .batch-results-list li.success { background: #d4edda; border-left-color: #28a745; }
        .batch-results-list li.failed { background: #f8d7da; border-left-color: #dc3545; }
        .batch-results-summary { padding: 15px; background: #e7f3ff; border-radius: 4px; margin-bottom: 15px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üïµÔ∏è Pending Manual Review</h1>
        </div>
    </div>

    <div class="container">
        <nav class="nav">
            <a href="{{basePath}}">Dashboard</a>
            <a href="{{basePath}}venues/pending">Pending Venues</a>
            <a href="{{basePath}}venues/manual-review" class="active">Pending Manual Review</a>
            <a href="{{basePath}}validation/history">History</a>
            <a href="{{basePath}}analytics">Analytics</a>
            <a href="{{basePath}}editorial-feedback">Editorial Feedback</a>
        </nav>

        <div class="filters">
            <form method="GET" id="filter-form">
                <input type="text" name="search" value="{{.Search}}" placeholder="Search...">
                <label style="display: inline-flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="checkbox" name="high_scores_only" value="true" {{if .HighScoresOnly}}checked{{end}}>
                    <span>Show only high scores (‚â• {{.ApprovalThreshold}})</span>
                </label>
                <select name="sort" id="sort-select" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;" onchange="document.getElementById('filter-form').submit();">
                    <option value="created_at" {{if eq .Sort "created_at"}}selected{{end}}>Sort by: Created At (Oldest First)</option>
                    <option value="last_updated" {{if eq .Sort "last_updated"}}selected{{end}}>Sort by: Last Updated At (Newest First)</option>
                    <option value="venue_id_asc" {{if eq .Sort "venue_id_asc"}}selected{{end}}>Sort by: Venue ID (Ascending)</option>
                    <option value="venue_id_desc" {{if eq .Sort "venue_id_desc"}}selected{{end}}>Sort by: Venue ID (Descending)</option>
                    <option value="score_desc" {{if eq .Sort "score_desc"}}selected{{end}}>Sort by: Score (Highest First)</option>
                    <option value="score_asc" {{if eq .Sort "score_asc"}}selected{{end}}>Sort by: Score (Lowest First)</option>
                </select>
                <button type="submit" class="btn">Filter</button>
                <a href="{{basePath}}venues/manual-review" class="btn">Clear</a>
            </form>
        </div>

        <div class="batch-controls" id="batch-controls" style="display: none;">
            <div class="selected-count" id="selected-count">0 venues selected</div>
            <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <button id="start-ai-btn" class="btn btn-success" onclick="startAIForSelected()" disabled>üöÄ Start AI-Assisted Review for Selected (0) Venues</button>
                <button class="btn btn-success" onclick="batchApprove()">‚úÖ Approve Selected</button>
                <button class="btn btn-danger" onclick="batchReject()">‚ùå Reject Selected</button>
                <button class="btn" onclick="selectAll()">Select All</button>
                <button class="btn" onclick="selectNone()">Select None</button>
            </div>
        </div>

        <div class="section" id="batch-results" style="display: none;">
            <h2>Batch Operation Results</h2>
            <div id="batch-results-content"></div>
        </div>

        <div class="section">
            <h2>Venues ({{.Total}} {{if .HighScoresOnly}}matching filter{{else}}total{{end}}, Page {{.Page}} of {{.TotalPages}})</h2>
            <table class="table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Location</th>
                        <th>Submitter</th>
                        <th>Authority</th>
                        <th>Score</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Items}}
                    <tr>
                        <td><input type="checkbox" class="venue-checkbox" value="{{.VenueWithUser.Venue.ID}}" onclick="updateBatchControls()"></td>
                        <td>{{.VenueWithUser.Venue.ID}}</td>
                        <td><strong>{{.VenueWithUser.Venue.Name}}</strong></td>
                        <td>{{.VenueWithUser.Venue.Location}}</td>
                        <td>{{.VenueWithUser.User.Username}}</td>
                        <td>
                            {{if .VenueWithUser.User.Trusted}}<span title="Trusted User">‚úÖ</span>{{end}}
                            {{if .VenueWithUser.IsVenueAdmin}}<span title="Venue Owner">üëë</span>{{end}}
                            {{if .VenueWithUser.AmbassadorLevel}}<span title="Ambassador">üåü</span>{{end}}
                        </td>
                        <td>
                            {{if ge .Score 85}}
                                <span class="score-badge score-high">{{.Score}}</span>
                            {{else if ge .Score 50}}
                                <span class="score-badge score-medium">{{.Score}}</span>
                            {{else}}
                                <span class="score-badge score-low">{{.Score}}</span>
                            {{end}}
                        </td>
                        <td class="actions-column">
                            <a href="{{basePath}}venues/{{.VenueWithUser.Venue.ID}}" class="btn btn-sm">View details</a>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>

        <div class="pagination">
            {{if gt .Page 1}}
                <a href="{{basePath}}venues/manual-review?page={{add .Page -1}}&search={{.Search}}{{if .HighScoresOnly}}&high_scores_only=true{{end}}&sort={{.Sort}}">¬´ Previous</a>
            {{end}}
            {{range $i := seq 1 .TotalPages}}
                {{if eq $i $.Page}}
                    <a href="#" class="active">{{$i}}</a>
                {{else if or (le $i 3) (ge $i (add $.TotalPages -2)) (and (ge $i (add $.Page -1)) (le $i (add $.Page 1)))}}
                    <a href="{{basePath}}venues/manual-review?page={{$i}}&search={{$.Search}}{{if $.HighScoresOnly}}&high_scores_only=true{{end}}&sort={{$.Sort}}">{{$i}}</a>
                {{end}}
            {{end}}
            {{if lt .Page .TotalPages}}
                <a href="{{basePath}}venues/manual-review?page={{add .Page 1}}&search={{.Search}}{{if .HighScoresOnly}}&high_scores_only=true{{end}}&sort={{.Sort}}">Next ¬ª</a>
            {{end}}
        </div>
    </div>

    <script>
        const basePath = '{{basePath}}';
        function updateBatchControls() {
            const count = document.querySelectorAll('.venue-checkbox:checked').length;
            const controls = document.getElementById('batch-controls');
            const countEl = document.getElementById('selected-count');
            const startBtn = document.getElementById('start-ai-btn');
            const plural = count === 1 ? '' : 's';
            controls.style.display = count > 0 ? 'block' : 'none';
            countEl.textContent = count + ' venue' + plural + ' selected';
            if (startBtn) {
                startBtn.disabled = count === 0;
                startBtn.textContent = 'üöÄ Start AI-Assisted Review for Selected (' + count + ') Venue' + plural;
            }
        }
        function toggleSelectAll() {
            const checked = document.getElementById('select-all').checked;
            document.querySelectorAll('.venue-checkbox').forEach(cb => cb.checked = checked);
            updateBatchControls();
        }
        function selectAll() { document.querySelectorAll('.venue-checkbox').forEach(cb => cb.checked = true); updateBatchControls(); }
        function selectNone() { document.querySelectorAll('.venue-checkbox').forEach(cb => cb.checked = false); document.getElementById('select-all').checked = false; updateBatchControls(); }

        function getSelectedIds() {
            return Array.from(document.querySelectorAll('.venue-checkbox:checked')).map(cb => cb.value);
        }
        async function startAIForSelected() {
            const ids = getSelectedIds();
            if (ids.length === 0) return;
            if (!confirm('Start AI-Assisted Review for ' + ids.length + ' selected venue' + (ids.length === 1 ? '' : 's') + '?')) {
                return;
            }
            const btn = document.getElementById('start-ai-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Queuing ' + ids.length + '...';
            try {
                const resp = await fetch(basePath + 'validate/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ venue_ids: ids.map(id => parseInt(id, 10)), force: true })
                });
                if (!resp.ok) {
                    throw new Error('Request failed with status ' + resp.status);
                }
                const data = await resp.json().catch(() => ({}));
                const queued = typeof data.queued === 'number' ? data.queued : 0;
                if (data.status === 'skipped' || queued === 0) {
                    alert('Nothing queued: ' + (data.reason || 'already processed or invalid IDs'));
                } else {
                    alert('Queued ' + queued + ' venue' + (queued === 1 ? '' : 's') + ' for AI-Assisted Review.');
                }
            } catch (e) {
                console.error(e);
                alert('Failed to start AI-Assisted Reviews.');
            } finally {
                setTimeout(() => { window.location.reload(); }, 800);
            }
        }
        function batchApprove() {
            const ids = getSelectedIds();
            if (ids.length === 0) return;
            if (!confirm('Approve ' + ids.length + ' selected venue' + (ids.length === 1 ? '' : 's') + '?')) return;
            batchOperation('approve', ids, 'Batch approval by admin');
        }
        function batchReject() {
            const ids = getSelectedIds();
            if (ids.length === 0) return;
            const reason = prompt('Enter rejection reason (required):');
            if (!reason || reason.trim() === '') {
                alert('Rejection reason is required');
                return;
            }
            batchOperation('reject', ids, reason);
        }
        function batchOperation(action, ids, reason) {
            const formData = new FormData();
            formData.append('action', action);
            formData.append('venue_ids', ids.join(','));
            formData.append('reason', reason);

            fetch(basePath + 'venues/batch-operation', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        displayBatchResults(data, action);
                        // Clear selections
                        selectNone();
                        // Reload after a delay to show results
                        setTimeout(() => location.reload(), 5000);
                    } else {
                        alert('No venues processed');
                    }
                })
                .catch(e => {
                    console.error(e);
                    alert('Error performing batch ' + action);
                });
        }

        function displayBatchResults(data, action) {
            const resultsSection = document.getElementById('batch-results');
            const resultsContent = document.getElementById('batch-results-content');

            // Build summary
            let html = '<div class="batch-results-summary">';
            html += 'Batch ' + action + ' completed: ' + data.success_count + '/' + data.total_count + ' successful';
            html += '</div>';

            // Build results list
            html += '<ul class="batch-results-list">';
            data.results.forEach((result, index) => {
                const num = index + 1;
                const name = result.venue_name || 'Unknown';
                const vid = result.venue_id;
                const status = result.status;
                const cssClass = result.success ? 'success' : 'failed';
                const reasonText = result.reason ? ' (Reason: ' + result.reason + ')' : '';

                html += '<li class="' + cssClass + '">';
                html += '<strong>' + num + '.</strong> ' + name + ' (<strong>' + vid + '</strong>) - Status: <strong>' + status + '</strong>' + reasonText;
                html += '</li>';
            });
            html += '</ul>';

            resultsContent.innerHTML = html;
            resultsSection.style.display = 'block';

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        function approveVenue(id) {
            if (!confirm('Approve this venue?')) return;
            const fd = new FormData(); fd.append('notes', 'Manual approval');
            fetch(basePath + 'venues/' + id + '/approve', { method: 'POST', body: fd })
                .then(r => r.ok ? location.reload() : alert('Error approving'))
                .catch(() => alert('Error approving'));
        }
        function rejectVenue(id) {
            const reason = prompt('Enter rejection reason (required):');
            if (!reason || reason.trim() === '') {
                alert('Rejection reason is required');
                return;
            }
            const fd = new FormData(); fd.append('reason', reason);
            fetch(basePath + 'venues/' + id + '/reject', { method: 'POST', body: fd })
                .then(r => r.ok ? location.reload() : alert('Error rejecting'))
                .catch(() => alert('Error rejecting'));
        }
    </script>
</body>
</html>
